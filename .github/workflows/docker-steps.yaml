name: Build, test, and push Docker Images

on:
  workflow_call:
    inputs:
      parent-image:
        description: Parent image name
        required: true
        type: string
      image:
        description: Image name
        required: true
        type: string
      base-image:
        description: The base image to build from if not located on our own repo
        required: false
        type: string
      registry-name:
        description: url of the registry <registy-name>.azurecr.io
        required: true
        type: string
    secrets:
      REGISTRY_USERNAME:
        description: The username for the container registry
        required: true
      REGISTRY_PASSWORD:
        description: The password for the container registry
        required: true

jobs:
  debug: 
    runs-on: ubuntu-latest
    steps:
      - name: secrets?
        run: echo "Username is ${{ secrets.REGISTRY_USERNAME }}"
  check-diff:
    uses: ./.github/workflows/check-diff.yaml
    with: 
      image: ${{ inputs.image }}

  build-upload:
    needs: [check-diff]
    if: needs.check-diff.outputs.is-diff
    uses: ./.github/workflows/docker-build-upload.yaml
    with:
      parent-image: ${{ inputs.parent-image }}
      image: ${{ inputs.image }}
      base-image: ${{ inputs.base-image }}
      registry-name: ${{ inputs.registry-name }}
    secrets:
      REGISTRY_USERNAME: ${{ secrets.DEV_REGISTRY_USERNAME }}
      REGISTRY_PASSWORD: ${{ secrets.DEV_REGISTRY_PASSWORD }}

  pull-upload:
    needs: [check-diff]
    if: ${{ !needs.check-diff.outputs.is-diff }}
    uses: ./.github/workflows/docker-pull-upload.yaml
    with:
      image: ${{ inputs.image }}
      registry-name: ${{ inputs.registry-name }}
    secrets:
      REGISTRY_USERNAME: ${{ secrets.DEV_REGISTRY_USERNAME }}
      REGISTRY_PASSWORD: ${{ secrets.DEV_REGISTRY_PASSWORD }}
