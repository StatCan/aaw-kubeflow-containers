name: Check for changes in subdirectory

on:
  workflow_call:
    inputs:
      image:
        description: Image name
        required: true
        type: string
    outputs:
      is-diff:
        description: Is there a difference between the master branch and the current branch
        value: ${{ jobs.check-diff.outputs.is-diff }}
        
jobs:
  check-diff:
    runs-on: ubuntu-latest
    outputs:
      is-diff: ${{ steps.check-changes.outputs.is-diff }}

    steps:
      - uses: actions/checkout@v4

      - name: Fetch master branch
        run: |
          git fetch origin staged-builds:staged-builds # TODO staged-builds:staged-builds to master:master

      - name: Check for changes
        id: check-changes
        run: | # Check for changes excluding README.md
          CHANGES=$(git diff --name-only origin/staged-builds HEAD -- "images/${{ inputs.image }}" | grep -v "README.md" || true) # TODO staged-builds to master for live

          if [ -n "$CHANGES" ]; then
            echo "Changes detected (excluding README.md)"
            echo "is-diff=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected"
            echo "is-diff=false" >> $GITHUB_OUTPUT
          fi